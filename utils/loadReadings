#!/usr/bin/env python3

"""
Make a new SQLite db with tables for sensor data and
insert  lines from data file generated by SensorDataReformat_v1.

This is only python with SQL. 
See extractSensorReadingsSliceSQLite.py for grasshopper python script to extract data.

Usage:
loadReadings --infile=InputFileName  --outdb=OutputDatabaseName 

Example:
loadReadings  --infile='All_data_2026-01-19.csv'  --outdb='SensorReadings_2026-01-19.db'
"""
import argparse
import os
import datetime
import sqlite3

parser = argparse.ArgumentParser(description= 
           'Create and populate SQLite db.')

parser.add_argument('--infile', type=str, default='output_v1.csv',
                    help='input data file as produced by SensorDataReformat_v1. Default: output_v1.csv')

parser.add_argument('--outdb', type=str, default='SenorReadings.sqlite.db',
                    help='output database file. Default: SenorReadings.sqlite.db')

args = parser.parse_args()

inpath=args.infile
if not os.path.isfile(inpath): 
   print('file   '  + inpath +' does not exist.')
   exit()

dbpath = args.outdb
if os.path.isfile(dbpath): 
   print('file   ' + args.outdb +' exists. Delete it first.')
   print('Error exit.')
   exit()

###################################################################
con = sqlite3.connect(dbpath)

#create sensorData  table
con.execute("""
  CREATE TABLE IF NOT EXISTS SensorData (
    ref INTEGER PRIMARY KEY AUTOINCREMENT,
    id TEXT NOT NULL,
    temperature REAL,
    timeStamp TIMESTAMP
  );""" )

i=0
e=0
#populate sensorData  table
with open(inpath, 'r') as f:
   for ln in f:
      i += 1
      fd = ln.split(',')  
      s = '("' + fd[0] + '", ' + fd[1] + ', "' + fd[2].lstrip() + '" )' # rm leading blank fd[2]
      q = 'INSERT INTO SensorData (id, temperature, timeStamp) VALUES ' + s 
      try:
         z = con.execute(q) #z= mutes printing of returned obj
      except:
         e += 1
         #print("query '" + q + "' failed!")
         #print("ln    '" + ln + "'")

print(inpath + " lines " + str(i))
print("error lines " + str(e))

con.commit()
con.close()
