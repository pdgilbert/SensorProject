#!/usr/bin/env python3

"""
Table SensorLocation is added to database dbpath and data in infile is used to populate it. 
If that database does not exist then it is created.
If table SensorLocation already exists then it is delated and recreated with the new data.
The lines in infile are expected to be as generated by Grasshopper script,
See grasshopeNotes.txt for more details.

This program is only python with SQL. 
See extractSensorReadingsSliceSQLite.py for a grasshopper python script to extract data
from the database and use it in Grasshopper.

Usage:
loadIDlocationsSQLite  --infile=InputLocationFile  --outdb=OutputDatabaseName 

Example:
loadSensorIDlocationsSQLite  --infile='sensorLocations.txt'  --outdb='SensorReadings.sqlite.db'
"""
import argparse
import os
#import datetime
import sqlite3

parser = argparse.ArgumentParser(description= 
           'Create and populate SQLite db.')

parser.add_argument('--infile', type=str, default='sensorLocations.txt',
                    help='input data file as produced by extractSensorIDLocations.ghx. Default: sensorLocations.txt')

parser.add_argument('--outdb', type=str, default='SenorReadings.sqlite.db',
                    help='input data file as produced bySensorDataReformat_v1. Default: SenorReadings.sqlite.db')

args = parser.parse_args()

inpath=args.infile
#print(inpath)

if not os.path.isfile(inpath): 
   print('file   ' + args.infile +' does not exist.')
   exit()

dbpath = args.outdb
#print(dbpath)

###################################################################
#con = sqlite3.connect("SenorReadings.sqlite.db")
con = sqlite3.connect(dbpath)

# drop the table if it exists, so it can be replaced
con.execute("DROP TABLE IF EXISTS SensorLocation")

#create and populate SensorLocation  table
con.execute("""
  CREATE TABLE IF NOT EXISTS SensorLocation (
     id TEXT PRIMARY KEY, 
     x   FLOAT,
     y   FLOAT,
     z   FLOAT 
  );""")

#populate sensorLocation  table
#with open('sensorLocations.txt', 'r') as f:
with open(inpath, 'r') as f:
   for ln in f:
      fd = ln.replace(' ', '').split('{') #remove blancks, in case space was used as separater
      s = '("' + fd[0] + '", ' + fd[1].replace('}', '') + ' )' # rm '}' in fd[1]
      q = 'INSERT INTO SensorLocation (id, x, y, z) VALUES ' + s 
      zz = con.execute(q) #zz= mutes printing returned obj.


#for v in con.execute("PRAGMA table_info(SensorLocation)"): print(v)  #SHOW TABLE 
#con.execute("DROP TABLE SensorLocation")    #to start over

con.commit()
con.close()
